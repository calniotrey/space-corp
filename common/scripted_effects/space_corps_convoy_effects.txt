#this = corp
create_convoy_fleet = {
	subtract_corp_money = {
		TYPE = convoy
		AMOUNT = @convoy_cost
	}
	create_fleet = {
		name = random
		effect = {
			set_owner = prev
			set_location = {
				target = event_target:headquarters_planet
				distance = 10
				angle = random
			}
			set_fleet_stance = passive
			create_ship = {
				name = random
				random_existing_design = corp_civilian_freighter
			}
			create_ship = {
				name = random
				random_existing_design = corp_civilian_tanker
			}
			create_ship = {
				name = random
				random_existing_design = corp_passenger_liner
			}
			# TODO make this spawn different ships
			set_timed_fleet_flag = {
				flag = should_not_destroy_convoy
				days = 1800				# TODO increase?
			}
			set_fleet_flag = fleet_needs_escort
			set_fleet_flag = space_corps_convoy
			fleet_event = {
				id = space_corps_convoy.20				# set name
			}
			set_convoy_orders = yes
		}
	}
}

# this = convoy fleet
# has headquarters loaded
set_convoy_orders = {
	if = {
		limit = {
			exists = orbit
			exists = event_target:convoy_destination
			orbit = {
				is_same_value = event_target:convoy_destination
			}
		}
		if = {
			limit = {
				has_fleet_flag = going_back
			}
			land_convoy_headquarters = yes			# will destroy fleet
		}
		else = {
			land_convoy_destination = yes
		}
	}
	if = {
		limit = {
			OR = {
				is_fleet_idle = yes
				has_fleet_flag = going_back_temp
			}
			exists = event_target:convoy_destination
		}
		clear_orders = yes
		# clear_fleet_actions = this
		# TODO check better
		if = {
			limit = {
				NOT = {
					has_fleet_flag = escort_caught_up
					# has_fleet_flag = fleet_needs_escort
				}
				exists = solar_system
				owner = {
					any_owned_fleet = {
						prevprev = {
							has_fleet_flag = is_escorted_by_@prev
						}
						exists = solar_system
						solar_system = {
							is_same_value = prevprevprev.solar_system
						}
					}
				}
			}
			set_fleet_flag = escort_caught_up
		}
		if = {
			limit = {
				OR = {
					has_fleet_flag = escort_caught_up
					# has_fleet_flag = fleet_needs_escort
				}
			}
			queue_actions = {
				move_to = event_target:convoy_destination
				orbit_planet = event_target:convoy_destination
			}
		}
	}
	if = {
		limit = {
			should_destroy_convoy = yes
		}
		delete_fleet = this
	}
	else = {
		save_event_target_as = convoy_fleet
		owner = {
			country_event = {
				id = space_corps_convoy.10
				days = 30
				random = 30
			}
		}
	}
}

# this = fleet
land_convoy_destination = {
	owner = {
		add_resource = {
			energy = @convoy_reward
		}
	}
	set_fleet_flag = going_back
	set_timed_fleet_flag = {
		flag = going_back_temp
		days = 1
	}
	event_target:headquarters_planet = {
		save_event_target_as = convoy_destination
	}
}

# this = fleet
land_convoy_headquarters = {
	owner = {
		change_corp_money = {
			TYPE = convoy
			AMOUNT = @convoy_cost
		}
		add_resource = {
			energy = @convoy_reward
		}
	}
	delete_fleet = this
}
