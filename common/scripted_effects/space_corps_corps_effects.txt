# this = corp
set_headquarters = {
	if = {
		limit = {
			exists = overlord
			overlord = {
				any_owned_planet = {
					suitable_for_headquarters = yes
				}
			}
		}
		overlord = {
			random_owned_planet = {
				limit = {
					suitable_for_headquarters = yes
				}
				set_planet_flag = space_corp_headquarters
				set_planet_flag = space_corp_headquarters_from_@prevprev
				save_event_target_as = headquarters_planet
			}
		}
		set_country_flag = space_corp_headquarters_set
		event_target:headquarters_planet = {
			prev = {
				set_country_flag = space_corp_headquarters_set_on_@prev
			}
		}
	}
}

# this = corp
get_headquarters = {
	overlord = {
		random_owned_planet = {
			limit = {
				has_planet_flag = space_corp_headquarters_from_@prevprev
			}
			save_event_target_as = headquarters_planet
		}
	}
}

# this = overlord
give_tech_overlord_and_corps = {
	give_technology = {
		tech = $TECH$
	}
	every_subject = {
		limit = {
			is_country_type = space_corp
		}
		give_technology = {
			tech = $TECH$
		}
	}
}

# this = overlord
give_tech_to_corps = {
	every_subject = {
		limit = {
			is_country_type = space_corp
		}
		give_technology = {
			tech = $TECH$
		}
	}
}

# this = corp
set_tech_costs = {
	get_galaxy_setup_value = {
		which = tech_base_cost
		setting = tech_costs_scale
	}
	multiply_variable = {
		which = tech_base_cost
		value = @tech_base_cost
	}
	if = {
		limit = {
			has_ethic = ethic_materialist
		}
		multiply_variable = {
			which = tech_base_cost
			value = 0.9
		}
	}
	set_variable = {
		which = tech_cost_t1
		value = 1
	}
	multiply_variable = {
		which = tech_cost_t1
		value = tech_base_cost
	}
	set_variable = {
		which = tech_cost_t2
		value = 2
	}
	multiply_variable = {
		which = tech_cost_t2
		value = tech_base_cost
	}
	set_variable = {
		which = tech_cost_t3
		value = 3
	}
	multiply_variable = {
		which = tech_cost_t3
		value = tech_base_cost
	}
	set_variable = {
		which = tech_cost_t4
		value = 4
	}
	multiply_variable = {
		which = tech_cost_t4
		value = tech_base_cost
	}
	set_variable = {
		which = tech_cost_t5
		value = 5
	}
	multiply_variable = {
		which = tech_cost_t5
		value = tech_base_cost
	}
}

# this = corp
get_survey_reward = {
	if = {
		limit = {
			overlord = {
				balance >= 3
				has_policy_flag = space_corps_survey_high_reward
			}
		}
		add_resource = {
			energy = 3
		}
		overlord = {
			add_resource = {
				energy = -3
			}
		}
	}
	else_if = {
		limit = {
			overlord = {
				balance >= 2
				has_policy_flag = space_corps_survey_medium_reward
			}
		}
		add_resource = {
			energy = 2
		}
		overlord = {
			add_resource = {
				energy = -2
			}
		}
	}
	else_if = {
		limit = {
			overlord = {
				balance >= 1
				has_policy_flag = space_corps_survey_low_reward
			}
		}
		add_resource = {
			energy = 1
		}
		overlord = {
			add_resource = {
				energy = -1
			}
		}
	}
	else_if = {
		limit = {
			overlord = {
				has_policy_flag = space_corps_survey_no_reward
			}
		}
		change_variable = {
			which = unhappiness
			value = 0.01
		}
	}
	else = {
		change_variable = {
			which = unhappiness
			value = 0.05
		}
	}
}

# this = corp
compute_and_tax_space_corp_income = {
	# TODO balance passive income
	get_headquarters = yes
	event_target:headquarters_planet = {
		every_owned_pop = {
			prevprev = {
				add_resource = {
					energy = 1
				}
			}
		}
	}
	compute_and_tax_space_corp_income_from_resource = {
		RESOURCE = energy
	}
	compute_and_tax_space_corp_income_from_resource = {
		RESOURCE = minerals
	}
	compute_and_tax_space_corp_income_from_resource = {
		RESOURCE = alloys
	}
	# now transform that as money
	change_variable = {
		which = space_corp_money
		value = space_corp_energy_income
	}
	change_variable = {
		which = space_corp_money
		value = space_corp_minerals_income
	}
	change_variable = {
		which = space_corp_money
		value = space_corp_alloys_income
	}
	change_variable = {
		which = space_corp_money
		value = space_corp_alloys_income
	}
	# twice because alloys = 2 energy here
	set_variable = {
		which = space_corp_total_taxed
		value = 0
	}
	change_variable = {
		which = space_corp_total_taxed
		value = space_corp_energy_taxed_total
	}
	change_variable = {
		which = space_corp_total_taxed
		value = space_corp_minerals_taxed_total
	}
	change_variable = {
		which = space_corp_total_taxed
		value = space_corp_alloys_taxed_total
	}
	change_variable = {
		which = space_corp_total_taxed
		value = space_corp_alloys_taxed_total
	}
	# twice because alloys = 2 energy here
	# compute month income
	set_variable = {
		which = space_corp_money_variation
		value = space_corp_money_last_month
	}
	multiply_variable = {
		which = space_corp_money_variation
		value = -1
	}
	change_variable = {
		which = space_corp_money_variation
		value = space_corp_money
	}
	# save money of last month
	set_variable = {
		which = space_corp_money_last_month
		value = space_corp_money
	}
}

# this = corp
# RESOURCE = one of the resource
compute_and_tax_space_corp_income_from_resource = {
	# reset income
	set_variable = {
		which = space_corp_$RESOURCE$_income
		value = 0
	}
	while = {
		limit = {
			has_resource = {
				type = $RESOURCE$
				amount >= 1100000
			}
		}
		add_monthly_resource_mult = {
			resource = $RESOURCE$
			value = 0
			min = -100000
			max = -100000
		}
		change_variable = {
			which = space_corp_$RESOURCE$_income
			value = 100000
		}
	}
	while = {
		limit = {
			has_resource = {
				type = $RESOURCE$
				amount >= 1010000
			}
		}
		add_monthly_resource_mult = {
			resource = $RESOURCE$
			value = 0
			min = -10000
			max = -10000
		}
		change_variable = {
			which = space_corp_$RESOURCE$_income
			value = 10000
		}
	}
	while = {
		limit = {
			has_resource = {
				type = $RESOURCE$
				amount >= 1001000
			}
		}
		add_monthly_resource_mult = {
			resource = $RESOURCE$
			value = 0
			min = -1000
			max = -1000
		}
		change_variable = {
			which = space_corp_$RESOURCE$_income
			value = 1000
		}
	}
	while = {
		limit = {
			has_resource = {
				type = $RESOURCE$
				amount >= 1000100
			}
		}
		add_monthly_resource_mult = {
			resource = $RESOURCE$
			value = 0
			min = -100
			max = -100
		}
		change_variable = {
			which = space_corp_$RESOURCE$_income
			value = 100
		}
	}
	while = {
		limit = {
			has_resource = {
				type = $RESOURCE$
				amount >= 1000010
			}
		}
		add_monthly_resource_mult = {
			resource = $RESOURCE$
			value = 0
			min = -10
			max = -10
		}
		change_variable = {
			which = space_corp_$RESOURCE$_income
			value = 10
		}
	}
	while = {
		limit = {
			has_resource = {
				type = $RESOURCE$
				amount >= 1000001
			}
		}
		add_monthly_resource_mult = {
			resource = $RESOURCE$
			value = 0
			min = -1
			max = -1
		}
		change_variable = {
			which = space_corp_$RESOURCE$_income
			value = 1
		}
	}
	# if negative
	while = {
		limit = {
			has_resource = {
				type = $RESOURCE$
				amount < 900000
			}
		}
		add_monthly_resource_mult = {
			resource = $RESOURCE$
			value = 0
			min = 100000
			max = 100000
		}
		change_variable = {
			which = space_corp_$RESOURCE$_income
			value = -100000
		}
	}
	while = {
		limit = {
			has_resource = {
				type = $RESOURCE$
				amount < 990000
			}
		}
		add_monthly_resource_mult = {
			resource = $RESOURCE$
			value = 0
			min = 10000
			max = 10000
		}
		change_variable = {
			which = space_corp_$RESOURCE$_income
			value = -10000
		}
	}
	while = {
		limit = {
			has_resource = {
				type = $RESOURCE$
				amount < 999000
			}
		}
		add_monthly_resource_mult = {
			resource = $RESOURCE$
			value = 0
			min = 1000
			max = 1000
		}
		change_variable = {
			which = space_corp_$RESOURCE$_income
			value = -1000
		}
	}
	while = {
		limit = {
			has_resource = {
				type = $RESOURCE$
				amount < 999900
			}
		}
		add_monthly_resource_mult = {
			resource = $RESOURCE$
			value = 0
			min = 100
			max = 100
		}
		change_variable = {
			which = space_corp_$RESOURCE$_income
			value = -100
		}
	}
	while = {
		limit = {
			has_resource = {
				type = $RESOURCE$
				amount < 999990
			}
		}
		add_monthly_resource_mult = {
			resource = $RESOURCE$
			value = 0
			min = 10
			max = 10
		}
		change_variable = {
			which = space_corp_$RESOURCE$_income
			value = -10
		}
	}
	while = {
		limit = {
			has_resource = {
				type = $RESOURCE$
				amount < 999999
			}
		}
		add_monthly_resource_mult = {
			resource = $RESOURCE$
			value = 0
			min = 1
			max = 1
		}
		change_variable = {
			which = space_corp_$RESOURCE$_income
			value = -1
		}
	}
	if = {
		limit = {
			check_variable = {
				which = space_corp_$RESOURCE$_income
				value >= 0
			}
		}
		overlord = {
			set_variable = {
				which = space_corp_$RESOURCE$_income
				value = prev
			}
			set_variable = {
				which = space_corp_taxes
				value = space_corp_$RESOURCE$_income
			}
			multiply_variable = {
				which = space_corp_taxes
				value = space_corps_taxes
			}
			add_variable_resource = {
				RESOURCE = $RESOURCE$
				AMOUNT = space_corp_taxes
			}
			change_variable = {
				which = space_corp_$RESOURCE$_taxed_total
				value = space_corp_taxes
			}
			prev = {
				set_variable = {
					which = space_corp_taxes
					value = prev
				}
				change_variable = {
					which = space_corp_$RESOURCE$_taxed_total
					value = space_corp_taxes
				}
				subtract_variable = {
					which = space_corp_$RESOURCE$_income
					value = space_corp_taxes
				}
			}
		}
	}
}

# this = corp
corps_load_research_points = {
	corps_load_research_points_resource = {
		RESOURCE = physics
	}
	corps_load_research_points_resource = {
		RESOURCE = society
	}
	corps_load_research_points_resource = {
		RESOURCE = engineering
	}
}

# this = corp
# RESOURCE = one of the 3 research fields
corps_load_research_points_resource = {
	while = {
		limit = {
			stored_$RESOURCE$_points >= 10000
		}
		add_monthly_resource_mult = {
			resource = $RESOURCE$_research
			value = 0
			min = -10000
			max = -10000
		}
		change_variable = {
			which = space_corp_stored_$RESOURCE$_points
			value = 10000
		}
	}
	while = {
		limit = {
			stored_$RESOURCE$_points >= 1000
		}
		add_monthly_resource_mult = {
			resource = $RESOURCE$_research
			value = 0
			min = -1000
			max = -1000
		}
		change_variable = {
			which = space_corp_stored_$RESOURCE$_points
			value = 1000
		}
	}
	while = {
		limit = {
			stored_$RESOURCE$_points >= 100
		}
		add_monthly_resource_mult = {
			resource = $RESOURCE$_research
			value = 0
			min = -100
			max = -100
		}
		change_variable = {
			which = space_corp_stored_$RESOURCE$_points
			value = 100
		}
	}
	while = {
		limit = {
			stored_$RESOURCE$_points >= 10
		}
		add_monthly_resource_mult = {
			resource = $RESOURCE$_research
			value = 0
			min = -10
			max = -10
		}
		change_variable = {
			which = space_corp_stored_$RESOURCE$_points
			value = 10
		}
	}
	while = {
		limit = {
			stored_$RESOURCE$_points >= 1
		}
		add_monthly_resource_mult = {
			resource = $RESOURCE$_research
			value = 0
			min = -1
			max = -1
		}
		change_variable = {
			which = space_corp_stored_$RESOURCE$_points
			value = 1
		}
	}
}
